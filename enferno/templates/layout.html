<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>ReadyKit - Production-Ready SaaS Template</title>
    <meta name="description" content="Multi-tenant SaaS starter template with Flask, Vue 3, and modern authentication">
    <meta name="author" content="ReadyKit">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/static/img/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="/static/css/vuetify.min.css">
    <link rel="stylesheet" href="/static/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
    <link rel="stylesheet" href="/static/css/layout.css">
    <link rel="stylesheet" href="/static/css/app.css">

    {% block css %}{% endblock %}
</head>

<body class="{% block body_class %} {% endblock %}">
<v-app id="app" v-cloak>
    <v-layout class="rounded rounded-md">
        <v-app-bar color="surface" density="comfortable" elevation="1">
            <v-app-bar-nav-icon @click="drawer = !drawer" class="d-md-none"></v-app-bar-nav-icon>

            <v-app-bar-title>
                <a href="/" class="text-decoration-none d-flex align-center">
                    <span class="text-h5 font-weight-bold">ReadyKit</span>
                </a>
            </v-app-bar-title>
            <v-spacer></v-spacer>

            <theme-switcher></theme-switcher>

            {% if not current_user.is_authenticated %}
            <v-btn href="/login" variant="text" class="ml-2">Sign in</v-btn>
            {% endif %}
        </v-app-bar>

        <v-navigation-drawer v-model="drawer">
            <v-list>
                {% if current_user.is_authenticated %}
                    <!-- Super Admin Navigation -->
                    {% if current_user.is_superadmin %}
                        <v-list-subheader>Platform Management</v-list-subheader>
                        <v-list-item
                            href="/dashboard"
                            title="Platform Overview"
                        >
                            <template v-slot:prepend><i class="ti ti-dashboard mr-4"></i></template>
                        </v-list-item>

                        <v-divider class="my-2"></v-divider>
                        <v-list-subheader>System Administration</v-list-subheader>
                        <v-list-item
                            href="/users/"
                            title="Manage Users"
                        >
                            <template v-slot:prepend><i class="ti ti-users mr-4"></i></template>
                        </v-list-item>
                        <v-list-item
                            href="/activities/"
                            title="Activity Log"
                        >
                            <template v-slot:prepend><i class="ti ti-history mr-4"></i></template>
                        </v-list-item>
                        
                        <!-- Current Workspace Context (if in workspace) -->
                        {% set current_workspace = get_current_workspace() %}
                        {% if current_workspace %}
                            <v-divider class="my-2"></v-divider>
                            <v-list-subheader class="d-flex align-center justify-space-between">
                                <span>{{ current_workspace.name }}</span>
                                {% if current_workspace.is_pro %}
                                <v-chip size="x-small" color="success" variant="flat" class="ml-2">Pro</v-chip>
                                {% endif %}
                            </v-list-subheader>
                            <v-list-item
                                href="/workspace/{{ current_workspace.id }}/"
                                title="Workspace Home"
                            >
                                <template v-slot:prepend><i class="ti ti-briefcase mr-4"></i></template>
                            </v-list-item>
                            <v-list-item
                                href="/workspace/{{ current_workspace.id }}/team/"
                                title="Manage Team"
                            >
                                <template v-slot:prepend><i class="ti ti-users mr-4"></i></template>
                            </v-list-item>
                            <v-list-item
                                href="/workspace/{{ current_workspace.id }}/settings/"
                                title="Settings"
                            >
                                <template v-slot:prepend><i class="ti ti-settings mr-4"></i></template>
                            </v-list-item>
                            <v-list-item
                                href="/dashboard"
                                title="Switch Workspace"
                            >
                                <template v-slot:prepend><i class="ti ti-switch-horizontal mr-4"></i></template>
                            </v-list-item>
                        {% endif %}

                        <!-- Account Section for Super Admin -->
                        <v-divider class="my-2"></v-divider>
                        <v-list-subheader>Account</v-list-subheader>
                        <v-list-item
                            href="/change"
                            title="Change Password"
                        >
                            <template v-slot:prepend><i class="ti ti-key mr-4"></i></template>
                        </v-list-item>
                        <v-list-item
                            href="/tf-setup"
                            title="Two-Factor Auth"
                        >
                            <template v-slot:prepend><i class="ti ti-shield-lock mr-4"></i></template>
                        </v-list-item>
                        <v-list-item
                            href="/mf-recovery-codes"
                            title="Recovery Codes"
                        >
                            <template v-slot:prepend><i class="ti ti-lifebuoy mr-4"></i></template>
                        </v-list-item>

                    {% else %}
                        <!-- Regular User Navigation -->
                        {% set current_workspace = get_current_workspace() %}
                        {% if current_workspace %}
                            <!-- User is in a workspace -->
                            <v-list-subheader class="d-flex align-center justify-space-between">
                                <span>{{ current_workspace.name }}</span>
                                {% if current_workspace.is_pro %}
                                <v-chip size="x-small" color="success" variant="flat" class="ml-2">Pro</v-chip>
                                {% endif %}
                            </v-list-subheader>
                            <v-list-item
                                href="/workspace/{{ current_workspace.id }}/"
                                title="Workspace Home"
                            >
                                <template v-slot:prepend><i class="ti ti-briefcase mr-4"></i></template>
                            </v-list-item>

                            <!-- Show team management if user is workspace admin -->
                            {% if current_user.get_workspace_role(current_workspace.id) == 'admin' %}
                                <v-list-item
                                    href="/workspace/{{ current_workspace.id }}/team/"
                                    title="Manage Team"
                                >
                                    <template v-slot:prepend><i class="ti ti-users mr-4"></i></template>
                                </v-list-item>
                            {% endif %}

                            <!-- Settings -->
                            <v-list-item
                                href="/workspace/{{ current_workspace.id }}/settings/"
                                title="Settings"
                            >
                                <template v-slot:prepend><i class="ti ti-settings mr-4"></i></template>
                            </v-list-item>

                            <!-- Show workspace switcher if user has multiple workspaces -->
                            {% if current_user.get_workspaces()|length > 1 %}
                                <v-list-item
                                    href="/dashboard"
                                    title="Switch Workspace"
                                >
                                    <template v-slot:prepend><i class="ti ti-switch-horizontal mr-4"></i></template>
                                </v-list-item>
                            {% endif %}

                            <!-- Account Section -->
                            <v-divider class="my-2"></v-divider>
                            <v-list-subheader>Account</v-list-subheader>
                            <v-list-item
                                href="/change"
                                title="Change Password"
                            >
                                <template v-slot:prepend><i class="ti ti-key mr-4"></i></template>
                            </v-list-item>
                            <v-list-item
                                href="/tf-setup"
                                title="Two-Factor Auth"
                            >
                                <template v-slot:prepend><i class="ti ti-shield-lock mr-4"></i></template>
                            </v-list-item>
                            <v-list-item
                                href="/mf-recovery-codes"
                                title="Recovery Codes"
                            >
                                <template v-slot:prepend><i class="ti ti-lifebuoy mr-4"></i></template>
                            </v-list-item>
                        {% else %}
                            <!-- User has no workspace access -->
                            <v-list-subheader>Getting Started</v-list-subheader>
                            <v-list-item
                                href="/dashboard"
                                title="Dashboard"
                            >
                                <template v-slot:prepend><i class="ti ti-dashboard mr-4"></i></template>
                            </v-list-item>
                            <v-list-item
                                title="Contact Admin"
                                subtitle="Request workspace access"
                            >
                                <template v-slot:prepend><i class="ti ti-help mr-4"></i></template>
                            </v-list-item>

                            <!-- Account Section for users without workspace -->
                            <v-divider class="my-2"></v-divider>
                            <v-list-subheader>Account</v-list-subheader>
                            <v-list-item
                                href="/change"
                                title="Change Password"
                            >
                                <template v-slot:prepend><i class="ti ti-key mr-4"></i></template>
                            </v-list-item>
                            <v-list-item
                                href="/tf-setup"
                                title="Two-Factor Auth"
                            >
                                <template v-slot:prepend><i class="ti ti-shield-lock mr-4"></i></template>
                            </v-list-item>
                            <v-list-item
                                href="/mf-recovery-codes"
                                title="Recovery Codes"
                            >
                                <template v-slot:prepend><i class="ti ti-lifebuoy mr-4"></i></template>
                            </v-list-item>
                        {% endif %}
                    {% endif %}
                {% else %}
                    <!-- Unauthenticated Navigation -->
                    <v-list-item href="/login" title="Login">
                        <template v-slot:prepend><i class="ti ti-login mr-4"></i></template>
                    </v-list-item>
                    <v-list-item href="/register" title="Sign Up">
                        <template v-slot:prepend><i class="ti ti-user-plus mr-4"></i></template>
                    </v-list-item>
                {% endif %}
            </v-list>
            
            <!-- User Profile Section at Bottom -->
            {% if current_user.is_authenticated %}
            <template v-slot:append>
                <v-divider class="mb-2"></v-divider>
                
                <!-- User Info Card -->
                <div class="pa-3">
                    <v-card variant="flat" color="transparent" class="d-flex align-center">
                        <v-avatar size="36" color="primary" class="mr-3">
                            <span class="text-white font-weight-bold text-body-2">{{ current_user.name[:1].upper() if current_user.name else 'U' }}</span>
                        </v-avatar>
                        
                        <div class="flex-grow-1 mr-2">
                            <div class="text-body-2 font-weight-medium text-truncate">
                                {{ current_user.name or 'User' }}
                            </div>
                            <div class="text-caption text-medium-emphasis">
                                {% if current_user.is_superadmin %}
                                    <v-chip size="x-small" color="primary" variant="tonal" class="px-2">
                                        <i class="ti ti-shield-check mr-1" style="font-size: 12px;"></i>
                                        Admin
                                    </v-chip>
                                {% else %}
                                    <span class="text-truncate">{{ current_user.email }}</span>
                                {% endif %}
                            </div>
                        </div>

                        <v-btn
                            href="/logout"
                            variant="text"
                            size="small"
                            color="medium-emphasis"
                            class="ml-auto"
                        >
                            <i class="ti ti-logout" style="font-size: 18px;"></i>
                            <v-tooltip activator="parent" location="top">Logout</v-tooltip>
                        </v-btn>
                    </v-card>
                </div>
            </template>
            {% endif %}
        </v-navigation-drawer>


        <v-main class="d-flex align-center justify-center" style="min-height: 300px;">
            {% block content %}
            {% endblock %}
        </v-main>

        <!-- Footer Attribution -->
        <v-footer app class="text-center py-2 text-caption text-medium-emphasis">
            <v-container>
                Powered by <a href="https://github.com/level09/enferno" target="_blank" class="text-decoration-none">Enferno Framework</a>
            </v-container>
        </v-footer>
        
        <!-- Flash messages (plain HTML - renders before Vue mounts) -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flash-messages" class="flash-container">
                {% for category, message in messages %}
                    <div class="flash-message {{ category if category in ['success', 'warning', 'error', 'info'] else 'primary' }}">
                        <span>{{ message }}</span>
                        <button class="flash-close" onclick="this.parentElement.remove()">&times;</button>
                    </div>
                {% endfor %}
            </div>

            <script>
                // Auto-hide flash messages after 5 seconds
                setTimeout(function() {
                    const flashMessages = document.getElementById('flash-messages');
                    if (flashMessages) {
                        flashMessages.style.display = 'none';
                    }
                }, 5000);
            </script>
        {% endif %}
        {% endwith %}
    </v-layout>
</v-app>
<script src="/static/js/vue.min.js"></script>
<script src="/static/js/config.js"></script>
<script src="/static/js/vuetify.min.js"></script>
<script src="/static/js/axios.min.js"></script>

<!-- Enferno Components -->
<script src="/static/js/components/TransitionExpand.js"></script>
<script src="/static/js/components/VerticalNavLink.js"></script>
<script src="/static/js/components/VerticalNavGroup.js"></script>
<script src="/static/js/components/VerticalNavSectionTitle.js"></script>
<script src="/static/js/components/NotificationDropdown.js"></script>
<script src="/static/js/components/ThemeSwitcher.js"></script>
<script src="/static/js/components/index.js"></script>

<script>
    // Base layout mixin for all pages
    const layoutMixin = {
        data() {
            return {
                drawer: true,
                isMobile: window.innerWidth < 960
            };
        },
        methods: {
            handleResize() {
                this.isMobile = window.innerWidth < 960;
            }
        },
        mounted() {
            window.addEventListener('resize', this.handleResize);
        },
        beforeUnmount() {
            window.removeEventListener('resize', this.handleResize);
        }
    };
</script>

{% block js %}{% endblock %}
</body>
</html>
