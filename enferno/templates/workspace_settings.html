{% extends "layout.html" %}

{% block content %}

<div class="pa-4 w-100">
    <!-- Header -->
    <div class="d-flex align-center justify-space-between mb-4">
        <div class="d-flex align-center">
            <v-btn
                href="/workspace/{{ workspace.id }}"
                icon="mdi-arrow-left"
                variant="text"
                size="small"
                class="mr-2"
            ></v-btn>
            <div>
                <h1 class="text-h5 font-weight-bold">Settings</h1>
                <p class="text-body-2 text-medium-emphasis mb-0">${ workspaceData.name }</p>
            </div>
        </div>
    </div>

    <!-- Status Banner -->
    <div class="d-flex align-center justify-space-between mb-6 pa-4" style="border: 1px solid #E4E4E7; border-radius: 8px;">
        <div class="d-flex align-center">
            <div>
                <div class="text-subtitle-1 font-weight-semibold">${ workspaceData.name }</div>
                <div class="d-flex align-center gap-2 mt-1">
                    <v-chip size="x-small" variant="outlined">
                        ${ workspaceData.is_pro ? 'Pro' : 'Free' }
                    </v-chip>
                    <span class="text-caption text-medium-emphasis">${ memberCount } member${ memberCount !== 1 ? 's' : '' }</span>
                </div>
            </div>
        </div>
        {% if user_role == 'admin' %}
        <v-btn
            v-if="!workspaceData.is_pro"
            color="accent"
            href="/workspace/{{ workspace.id }}/upgrade"
            class="text-none"
        >
            Upgrade to Pro
        </v-btn>
        <v-btn
            v-else
            variant="outlined"
            href="/workspace/{{ workspace.id }}/billing"
            class="text-none"
        >
            Manage Billing
        </v-btn>
        {% endif %}
    </div>

    <!-- Tabs -->
    <v-card>
        <v-tabs v-model="activeTab" class="settings-tabs">
            <v-tab value="general">
                <i class="ti ti-user mr-2"></i>
                General
            </v-tab>
            <v-tab value="billing">
                <i class="ti ti-credit-card mr-2"></i>
                Plan & Billing
            </v-tab>
            <v-tab value="danger">
                <i class="ti ti-alert-triangle mr-2"></i>
                Danger Zone
            </v-tab>
        </v-tabs>

        <v-divider></v-divider>

        <v-tabs-window v-model="activeTab">
            <!-- General Tab -->
            <v-tabs-window-item value="general">
                <v-card-text class="pa-6">
                    <v-row>
                        <!-- Workspace Settings -->
                        <v-col cols="12" md="6">
                            <h3 class="text-subtitle-1 font-weight-semibold mb-4">
                                <i class="ti ti-briefcase mr-2 text-medium-emphasis"></i>
                                Workspace
                            </h3>
                            <v-form @submit.prevent="updateWorkspaceName">
                                <v-text-field
                                    label="Workspace Name"
                                    v-model="workspaceData.name"
                                    variant="outlined"
                                    density="comfortable"
                                    :readonly="'{{ user_role }}' !== 'admin'"
                                    class="mb-2"
                                ></v-text-field>
                                {% if user_role == 'admin' %}
                                <v-btn
                                    color="primary"
                                    variant="flat"
                                    @click="updateWorkspaceName"
                                    :loading="savingWorkspace"
                                    class="text-none"
                                >
                                    Save Changes
                                </v-btn>
                                {% else %}
                                <p class="text-body-2 text-medium-emphasis">
                                    <i class="ti ti-lock mr-1"></i>
                                    Only admins can modify workspace settings
                                </p>
                                {% endif %}
                            </v-form>
                        </v-col>

                        <!-- Profile Settings -->
                        <v-col cols="12" md="6">
                            <h3 class="text-subtitle-1 font-weight-semibold mb-4">
                                <i class="ti ti-user mr-2 text-medium-emphasis"></i>
                                My Profile
                            </h3>
                            <v-form @submit.prevent="updateProfile">
                                <v-text-field
                                    label="Name"
                                    v-model="userData.name"
                                    variant="outlined"
                                    density="comfortable"
                                    class="mb-3"
                                ></v-text-field>
                                <v-text-field
                                    label="Email"
                                    v-model="userData.email"
                                    variant="outlined"
                                    density="comfortable"
                                    type="email"
                                    readonly
                                    class="mb-2"
                                >
                                    <template v-slot:append-inner>
                                        <v-tooltip text="Email cannot be changed for security">
                                            <template v-slot:activator="{ props }">
                                                <i class="ti ti-lock text-medium-emphasis" v-bind="props"></i>
                                            </template>
                                        </v-tooltip>
                                    </template>
                                </v-text-field>
                                <v-btn
                                    color="primary"
                                    variant="flat"
                                    @click="updateProfile"
                                    :loading="savingProfile"
                                    class="text-none"
                                >
                                    Update Profile
                                </v-btn>
                            </v-form>
                        </v-col>
                    </v-row>

                    <!-- Workspace Info -->
                    <v-divider class="my-6"></v-divider>
                    <h3 class="text-subtitle-1 font-weight-semibold mb-4">
                        <i class="ti ti-info-circle mr-2 text-medium-emphasis"></i>
                        Workspace Details
                    </h3>
                    <v-row>
                        <v-col cols="6" sm="3">
                            <div class="text-caption text-medium-emphasis mb-1">Your Role</div>
                            <v-chip size="small" variant="outlined">
                                {{ user_role.title() }}
                            </v-chip>
                        </v-col>
                        <v-col cols="6" sm="3">
                            <div class="text-caption text-medium-emphasis mb-1">Plan</div>
                            <v-chip size="small" variant="outlined">
                                ${ workspaceData.is_pro ? 'Pro' : 'Free' }
                            </v-chip>
                        </v-col>
                        <v-col cols="6" sm="3">
                            <div class="text-caption text-medium-emphasis mb-1">Members</div>
                            <div class="text-body-2 font-weight-medium">${ memberCount }</div>
                        </v-col>
                        <v-col cols="6" sm="3">
                            <div class="text-caption text-medium-emphasis mb-1">Created</div>
                            <div class="text-body-2">${ workspaceData.created_at ? new Date(workspaceData.created_at).toLocaleDateString() : 'â€”' }</div>
                        </v-col>
                    </v-row>
                </v-card-text>
            </v-tabs-window-item>

            <!-- Billing Tab -->
            <v-tabs-window-item value="billing">
                <v-card-text class="pa-6">
                    {% if user_role == 'admin' %}

                    <!-- Free Plan -->
                    <div v-if="!workspaceData.is_pro">
                        <v-row>
                            <v-col cols="12" md="6">
                                <h3 class="text-subtitle-1 font-weight-semibold mb-4">Current Plan</h3>
                                <v-card variant="outlined" class="pa-4">
                                    <div class="d-flex align-center justify-space-between mb-3">
                                        <v-chip size="small" variant="outlined">Free</v-chip>
                                        <span class="text-h5 font-weight-bold">$0<span class="text-body-2 font-weight-regular text-medium-emphasis">/month</span></span>
                                    </div>
                                    <ul class="feature-list text-body-2">
                                        <li><i class="ti ti-check" style="opacity: 0.4;"></i> Up to 3 team members</li>
                                        <li><i class="ti ti-check" style="opacity: 0.4;"></i> Basic features</li>
                                        <li><i class="ti ti-x" style="opacity: 0.2;"></i> <span class="text-medium-emphasis">Advanced analytics</span></li>
                                        <li><i class="ti ti-x" style="opacity: 0.2;"></i> <span class="text-medium-emphasis">Priority support</span></li>
                                    </ul>
                                    <v-divider class="my-4"></v-divider>
                                    <div class="d-flex justify-space-between align-center">
                                        <span class="text-body-2 text-medium-emphasis">Team members</span>
                                        <span class="text-body-2 font-weight-semibold">${ memberCount } / 3</span>
                                    </div>
                                </v-card>
                            </v-col>

                            <v-col cols="12" md="6">
                                <h3 class="text-subtitle-1 font-weight-semibold mb-4">Upgrade</h3>
                                <v-card variant="outlined" class="pa-4">
                                    <div class="d-flex align-center justify-space-between mb-3">
                                        <v-chip size="small" variant="outlined">Pro</v-chip>
                                        <span class="text-h5 font-weight-bold">{{ pro_price }}<span class="text-body-2 font-weight-regular text-medium-emphasis">/{{ pro_interval }}</span></span>
                                    </div>
                                    <ul class="feature-list text-body-2 mb-4">
                                        <li><i class="ti ti-check" style="opacity: 0.4;"></i> Unlimited team members</li>
                                        <li><i class="ti ti-check" style="opacity: 0.4;"></i> Advanced analytics & reporting</li>
                                        <li><i class="ti ti-check" style="opacity: 0.4;"></i> Data export capabilities</li>
                                        <li><i class="ti ti-check" style="opacity: 0.4;"></i> Priority support</li>
                                    </ul>
                                    <v-btn
                                        block
                                        color="accent"
                                        href="/workspace/{{ workspace.id }}/upgrade"
                                        class="text-none"
                                    >
                                        Upgrade Now
                                    </v-btn>
                                </v-card>
                            </v-col>
                        </v-row>
                    </div>

                    <!-- Pro Plan Active -->
                    <div v-else>
                        <v-card variant="outlined" class="pa-4" style="max-width: 480px;">
                            <div class="d-flex align-center justify-space-between mb-3">
                                <v-chip size="small" variant="outlined">Pro</v-chip>
                                <span class="text-h5 font-weight-bold">{{ pro_price }}<span class="text-body-2 font-weight-regular text-medium-emphasis">/{{ pro_interval }}</span></span>
                            </div>
                            <ul class="feature-list text-body-2 mb-4">
                                <li><i class="ti ti-check" style="opacity: 0.4;"></i> Unlimited team members</li>
                                <li><i class="ti ti-check" style="opacity: 0.4;"></i> Advanced analytics & reporting</li>
                                <li><i class="ti ti-check" style="opacity: 0.4;"></i> Data export capabilities</li>
                                <li><i class="ti ti-check" style="opacity: 0.4;"></i> Priority support</li>
                            </ul>
                            <div class="text-body-2 text-medium-emphasis mb-3">
                                ${ memberCount } team members
                                <span v-if="workspaceData.upgraded_at"> &middot; Upgraded ${ new Date(workspaceData.upgraded_at).toLocaleDateString() }</span>
                            </div>
                            <v-btn
                                block
                                variant="outlined"
                                href="/workspace/{{ workspace.id }}/billing"
                                class="text-none"
                            >
                                Manage Subscription
                            </v-btn>
                        </v-card>
                    </div>

                    {% else %}
                    <p class="text-body-2 text-medium-emphasis mb-0">
                        Billing is managed by the workspace admin.
                    </p>
                    {% endif %}
                </v-card-text>
            </v-tabs-window-item>

            <!-- Danger Zone Tab -->
            <v-tabs-window-item value="danger">
                <v-card-text class="pa-6">
                    <p class="text-body-2 text-medium-emphasis mb-6">Actions here are destructive and cannot be undone.</p>

                    {% if user_role == 'admin' %}
                    <v-card variant="outlined" class="pa-4">
                        <div class="d-flex flex-column flex-sm-row align-sm-center justify-space-between">
                            <div class="mb-3 mb-sm-0">
                                <div class="text-subtitle-2 font-weight-semibold">Delete Workspace</div>
                                <div class="text-body-2 text-medium-emphasis">Permanently delete this workspace and all its data.</div>
                            </div>
                            <v-btn
                                color="error"
                                variant="outlined"
                                @click="confirmDeleteWorkspace"
                                class="text-none"
                            >
                                Delete Workspace
                            </v-btn>
                        </div>
                    </v-card>
                    {% else %}
                    <v-card variant="outlined" class="pa-4">
                        <div class="d-flex flex-column flex-sm-row align-sm-center justify-space-between">
                            <div class="mb-3 mb-sm-0">
                                <div class="text-subtitle-2 font-weight-semibold">Leave Workspace</div>
                                <div class="text-body-2 text-medium-emphasis">Remove yourself from this workspace. You'll lose access immediately.</div>
                            </div>
                            <v-btn
                                variant="outlined"
                                @click="confirmLeaveWorkspace"
                                class="text-none"
                            >
                                Leave Workspace
                            </v-btn>
                        </div>
                    </v-card>
                    {% endif %}
                </v-card-text>
            </v-tabs-window-item>
        </v-tabs-window>
    </v-card>
</div>

<!-- Success/Error Messages -->
<v-snackbar
    v-model="snackbar"
    :color="snackColor"
    timeout="4000"
    location="bottom right"
>
    ${ snackMessage }
    <template v-slot:actions>
        <v-btn variant="text" @click="snackbar = false">Close</v-btn>
    </template>
</v-snackbar>

{% endblock %}

{% block js %}

<script type="application/json" id="workspace-data">
{{ workspace.to_dict()|tojson|safe }}
</script>

<script type="application/json" id="user-data">
{{ {"name": current_user.name, "email": current_user.email}|tojson|safe }}
</script>

<script>
const { createApp } = Vue;
const { createVuetify } = Vuetify;
const vuetify = createVuetify(config.vuetifyConfig);

const app = createApp({
    data() {
        return {
            drawer: true,
            activeTab: 'general',
            memberCount: 0,
            workspaceData: {
                id: null,
                name: '',
                created_at: null,
                is_pro: false,
                upgraded_at: null
            },
            userData: {
                name: '',
                email: ''
            },
            savingWorkspace: false,
            savingProfile: false,
            snackbar: false,
            snackMessage: '',
            snackColor: 'success'
        };
    },
    delimiters: config.delimiters,

    methods: {
        async updateWorkspaceName() {
            this.savingWorkspace = true;
            try {
                const response = await axios.put(`/api/workspace/${this.workspaceData.id}`, {
                    name: this.workspaceData.name
                });
                this.showMessage('Workspace name updated successfully!', 'success');
            } catch (error) {
                this.showMessage('Failed to update workspace name', 'error');
                console.error('Error updating workspace:', error);
            } finally {
                this.savingWorkspace = false;
            }
        },

        async updateProfile() {
            this.savingProfile = true;
            try {
                const response = await axios.put('/api/profile', {
                    name: this.userData.name
                });
                this.showMessage('Profile updated successfully!', 'success');
            } catch (error) {
                this.showMessage('Failed to update profile', 'error');
                console.error('Error updating profile:', error);
            } finally {
                this.savingProfile = false;
            }
        },

        showMessage(message, color = 'success') {
            this.snackMessage = message;
            this.snackColor = color;
            this.snackbar = true;
        },

        confirmDeleteWorkspace() {
            if (confirm('Are you sure you want to delete this workspace? This action cannot be undone.')) {
                alert('Workspace deletion not yet implemented');
            }
        },

        confirmLeaveWorkspace() {
            if (confirm('Are you sure you want to leave this workspace? You\'ll lose access immediately.')) {
                alert('Leave workspace not yet implemented');
            }
        },

        async loadStats() {
            try {
                const response = await axios.get(`/api/workspace/${this.workspaceData.id}/stats`);
                this.memberCount = response.data.member_count || 0;
            } catch (error) {
                console.error('Failed to load stats:', error);
                this.memberCount = 0;
            }
        }
    },

    async mounted() {
        this.workspaceData = JSON.parse(document.querySelector('#workspace-data').textContent);
        this.userData = JSON.parse(document.querySelector('#user-data').textContent);
        await this.loadStats();
    }
}).use(vuetify).mount('#app');
</script>
{% endblock %}
