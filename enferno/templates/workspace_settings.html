{% extends "layout.html" %}

{% block content %}

<div class="pa-4 w-100" style="max-width: 700px;">
    <!-- Header -->
    <div class="d-flex align-center mb-6">
        <v-btn
            href="/workspace/{{ workspace.id }}"
            icon="mdi-arrow-left"
            variant="text"
            size="small"
            class="mr-2"
        ></v-btn>
        <div>
            <h1 class="text-h5 font-weight-bold">Settings</h1>
            <p class="text-body-2 text-medium-emphasis mb-0">${ workspaceData.name }</p>
        </div>
    </div>

    <!-- Workspace Name -->
    {% if user_role == 'admin' %}
    <div class="mb-6">
        <div class="text-subtitle-2 font-weight-medium mb-3">Workspace Name</div>
        <v-form @submit.prevent="updateWorkspaceName">
            <v-text-field
                v-model="workspaceData.name"
                density="comfortable"
                class="mb-2"
                style="max-width: 400px;"
            ></v-text-field>
            <v-btn
                color="primary"
                @click="updateWorkspaceName"
                :loading="savingWorkspace"
                class="text-none"
            >
                Save
            </v-btn>
        </v-form>
    </div>
    {% else %}
    <div class="mb-6">
        <div class="text-subtitle-2 font-weight-medium mb-1">Workspace Name</div>
        <div class="text-body-2">${ workspaceData.name }</div>
    </div>
    {% endif %}

    <v-divider class="mb-6"></v-divider>

    <!-- Profile -->
    <div class="mb-6">
        <div class="text-subtitle-2 font-weight-medium mb-3">Profile</div>
        <v-form @submit.prevent="updateProfile">
            <v-text-field
                label="Name"
                v-model="userData.name"
                density="comfortable"
                class="mb-2"
                style="max-width: 400px;"
            ></v-text-field>
            <v-text-field
                label="Email"
                v-model="userData.email"
                density="comfortable"
                type="email"
                readonly
                style="max-width: 400px;"
                class="mb-2"
            >
                <template v-slot:append-inner>
                    <v-tooltip text="Email cannot be changed for security">
                        <template v-slot:activator="{ props }">
                            <i class="ti ti-lock text-medium-emphasis" v-bind="props"></i>
                        </template>
                    </v-tooltip>
                </template>
            </v-text-field>
            <v-btn
                color="primary"
                @click="updateProfile"
                :loading="savingProfile"
                class="text-none"
            >
                Update Profile
            </v-btn>
        </v-form>
    </div>

    <v-divider class="mb-6"></v-divider>

    <!-- Workspace Details -->
    <div class="mb-6">
        <div class="text-subtitle-2 font-weight-medium mb-3">Details</div>
        <div class="d-flex flex-wrap ga-6">
            <div>
                <div class="text-caption text-medium-emphasis mb-1">Role</div>
                <div class="text-body-2">{{ user_role.title() }}</div>
            </div>
            <div>
                <div class="text-caption text-medium-emphasis mb-1">Plan</div>
                <div class="text-body-2">${ workspaceData.is_pro ? 'Pro' : 'Free' }</div>
            </div>
            <div>
                <div class="text-caption text-medium-emphasis mb-1">Members</div>
                <div class="text-body-2">${ memberCount }</div>
            </div>
            <div>
                <div class="text-caption text-medium-emphasis mb-1">Created</div>
                <div class="text-body-2">${ workspaceData.created_at ? new Date(workspaceData.created_at).toLocaleDateString() : '—' }</div>
            </div>
        </div>
    </div>

    {% if user_role == 'admin' %}
    <v-divider class="mb-6"></v-divider>

    <!-- Plan & Billing -->
    <div class="mb-6">
        <div class="text-subtitle-2 font-weight-medium mb-3">Plan & Billing</div>

        <div v-if="!workspaceData.is_pro">
            <div class="text-body-2 text-medium-emphasis mb-3">
                You're on the <strong>Free</strong> plan.
            </div>
            <v-btn
                color="primary"
                href="/workspace/{{ workspace.id }}/upgrade"
                class="text-none"
            >
                Upgrade to Pro — {{ pro_price }}/{{ pro_interval }}
            </v-btn>
        </div>

        <div v-else>
            <div class="text-body-2 text-medium-emphasis mb-3">
                You're on the <strong>Pro</strong> plan — {{ pro_price }}/{{ pro_interval }}.
                <span v-if="workspaceData.upgraded_at">Upgraded ${ new Date(workspaceData.upgraded_at).toLocaleDateString() }.</span>
            </div>
            <v-btn
                variant="outlined"
                href="/workspace/{{ workspace.id }}/billing"
                class="text-none"
            >
                Manage Subscription
            </v-btn>
        </div>
    </div>

    <v-divider class="mb-6"></v-divider>

    <!-- Danger Zone -->
    <div class="mb-6">
        <div class="text-subtitle-2 font-weight-medium mb-3" style="color: #DC2626;">Danger Zone</div>
        <div class="d-flex flex-column flex-sm-row align-sm-center justify-space-between pa-4" style="border: 1px solid #FECACA; border-radius: 8px;">
            <div class="mb-3 mb-sm-0">
                <div class="text-body-2 font-weight-medium">Delete Workspace</div>
                <div class="text-caption text-medium-emphasis">Permanently delete this workspace and all its data.</div>
            </div>
            <v-btn
                color="error"
                variant="outlined"
                @click="confirmDeleteWorkspace"
                class="text-none"
            >
                Delete
            </v-btn>
        </div>
    </div>

    {% else %}
    <v-divider class="mb-6"></v-divider>

    <!-- Leave Workspace (non-admin) -->
    <div class="mb-6">
        <div class="d-flex flex-column flex-sm-row align-sm-center justify-space-between pa-4" style="border: 1px solid #E4E4E7; border-radius: 8px;">
            <div class="mb-3 mb-sm-0">
                <div class="text-body-2 font-weight-medium">Leave Workspace</div>
                <div class="text-caption text-medium-emphasis">Remove yourself from this workspace.</div>
            </div>
            <v-btn
                variant="outlined"
                @click="confirmLeaveWorkspace"
                class="text-none"
            >
                Leave
            </v-btn>
        </div>
    </div>
    {% endif %}
</div>

<!-- Snackbar -->
<v-snackbar
    v-model="snackbar"
    :color="snackColor"
    timeout="4000"
    location="bottom right"
>
    ${ snackMessage }
    <template v-slot:actions>
        <v-btn variant="text" @click="snackbar = false">Close</v-btn>
    </template>
</v-snackbar>

{% endblock %}

{% block js %}

<script type="application/json" id="workspace-data">
{{ workspace.to_dict()|tojson|safe }}
</script>

<script type="application/json" id="user-data">
{{ {"name": current_user.name, "email": current_user.email}|tojson|safe }}
</script>

<script>
const { createApp } = Vue;
const { createVuetify } = Vuetify;
const vuetify = createVuetify(config.vuetifyConfig);

const app = createApp({
    mixins: [layoutMixin],
    data() {
        return {
            memberCount: 0,
            workspaceData: {
                id: null,
                name: '',
                created_at: null,
                is_pro: false,
                upgraded_at: null
            },
            userData: {
                name: '',
                email: ''
            },
            savingWorkspace: false,
            savingProfile: false,
            snackbar: false,
            snackMessage: '',
            snackColor: 'success'
        };
    },
    delimiters: config.delimiters,

    methods: {
        async updateWorkspaceName() {
            this.savingWorkspace = true;
            try {
                await axios.put(`/api/workspace/${this.workspaceData.id}`, {
                    name: this.workspaceData.name
                });
                this.showMessage('Workspace name updated', 'success');
            } catch (error) {
                this.showMessage('Failed to update workspace name', 'error');
            } finally {
                this.savingWorkspace = false;
            }
        },

        async updateProfile() {
            this.savingProfile = true;
            try {
                await axios.put('/api/profile', {
                    name: this.userData.name
                });
                this.showMessage('Profile updated', 'success');
            } catch (error) {
                this.showMessage('Failed to update profile', 'error');
            } finally {
                this.savingProfile = false;
            }
        },

        showMessage(message, color = 'success') {
            this.snackMessage = message;
            this.snackColor = color;
            this.snackbar = true;
        },

        confirmDeleteWorkspace() {
            if (confirm('Are you sure you want to delete this workspace? This action cannot be undone.')) {
                alert('Workspace deletion not yet implemented');
            }
        },

        confirmLeaveWorkspace() {
            if (confirm('Are you sure you want to leave this workspace? You\'ll lose access immediately.')) {
                alert('Leave workspace not yet implemented');
            }
        },

        async loadStats() {
            try {
                const response = await axios.get(`/api/workspace/${this.workspaceData.id}/stats`);
                this.memberCount = response.data.member_count || 0;
            } catch (error) {
                this.memberCount = 0;
            }
        }
    },

    async mounted() {
        this.workspaceData = JSON.parse(document.querySelector('#workspace-data').textContent);
        this.userData = JSON.parse(document.querySelector('#user-data').textContent);
        await this.loadStats();
    }
}).use(vuetify).mount('#app');
</script>
{% endblock %}
