{% extends 'layout.html' %}
{% block content %}

<v-container fluid class="pa-4">
    <!-- Header Section -->
    <v-row class="mb-6">
        <v-col cols="12">
            <div class="d-flex align-center justify-space-between">
                <div>
                    <h1 class="text-h4 font-weight-medium mb-1">
                        {% if current_user.is_superadmin %}
                            Platform Overview
                        {% else %}
                            Your Workspaces
                        {% endif %}
                    </h1>
                    <p class="text-body-2 text-medium-emphasis">
                        {% if current_user.is_superadmin %}
                            Manage the entire platform, workspaces, and users
                        {% else %}
                            Choose a workspace to get started
                        {% endif %}
                    </p>
                </div>
                {% if current_user.is_superadmin %}
                <v-btn
                    color="primary"
                    prepend-icon="mdi-plus"
                    @click="createDialog = true"
                >
                    Create Workspace
                </v-btn>
                {% endif %}
            </div>
        </v-col>
    </v-row>


    <!-- Workspaces Section -->
    <div v-if="workspaces.length > 0">
        <div class="d-flex align-center mb-4">
            <h2 class="text-h6 font-weight-medium">
                {% if current_user.is_superadmin %}
                    All Workspaces
                {% else %}
                    Your Workspaces
                {% endif %}
            </h2>
            <v-spacer></v-spacer>
            <span class="text-body-2 text-medium-emphasis">${workspaces.length} workspace${workspaces.length !== 1 ? 's' : ''}</span>
        </div>

        <v-row>
            <v-col
                v-for="workspace in workspaces"
                :key="workspace.id"
                cols="12"
                sm="6"
                lg="4"
            >
                <v-card
                    :href="`/workspace/${workspace.id}/switch/`"
                    variant="outlined"
                    class="h-100"
                >
                    <v-card-text class="pa-4">
                        <div class="d-flex align-center mb-3">
                            <div class="flex-grow-1">
                                <div class="d-flex align-center">
                                    <div class="text-subtitle-1 font-weight-medium mr-2">${workspace.name}</div>
                                    <v-chip v-if="workspace.is_pro" size="x-small" variant="outlined">Pro</v-chip>
                                </div>
                                <div class="text-body-2 text-medium-emphasis">
                                    {% if current_user.is_superadmin %}
                                        Client workspace
                                    {% else %}
                                        ${workspace.user_role}
                                    {% endif %}
                                </div>
                            </div>
                            <i class="ti ti-chevron-right" style="opacity: 0.3;"></i>
                        </div>
                    </v-card-text>
                </v-card>
            </v-col>
        </v-row>
    </div>

    <!-- Empty State -->
    <div v-else class="text-center py-16">
        <i class="ti ti-briefcase-2 mb-4" style="font-size: 48px; opacity: 0.15;"></i>
        <h2 class="text-h6 font-weight-medium mb-3">No workspaces yet</h2>
        <p class="text-body-2 text-medium-emphasis mb-6">
            {% if current_user.is_superadmin %}
                Create your first workspace to get started.
            {% else %}
                Contact your administrator to join a workspace.
            {% endif %}
        </p>
        {% if current_user.is_superadmin %}
        <v-btn
            color="primary"
            @click="createDialog = true"
            prepend-icon="mdi-plus"
        >
            Create Workspace
        </v-btn>
        {% endif %}
    </div>
    
</v-container>

<!-- Create Workspace Dialog -->
<v-dialog v-model="createDialog" max-width="440" persistent>
    <v-card>
        <v-card-title class="d-flex align-center justify-space-between">
            <span>New Workspace</span>
            <v-btn @click="createDialog=false" icon="mdi-close" variant="text" size="small"></v-btn>
        </v-card-title>

        <v-card-text class="pb-0">
            <v-text-field
                label="Workspace Name"
                v-model="newWorkspaceName"
                :rules="[rules.required]"
                placeholder="e.g. Acme Corporation"
                hide-details="auto"
                class="mb-2"
            ></v-text-field>
            <p class="text-caption text-medium-emphasis">You'll be the admin and can invite team members later.</p>
        </v-card-text>

        <v-card-actions class="px-6 pb-6">
            <v-spacer></v-spacer>
            <v-btn @click="createDialog=false" variant="text" :disabled="creating">Cancel</v-btn>
            <v-btn
                color="primary"
                @click="createWorkspace"
                :loading="creating"
            >
                Create
            </v-btn>
        </v-card-actions>
    </v-card>
</v-dialog>

<v-snackbar
    v-model="snackBar"
    :color="snackColor"
    location="bottom right"
    timeout="4000"
>
    ${snackMessage}
    <template v-slot:actions>
        <v-btn @click="snackBar=false" variant="text" size="small">Close</v-btn>
    </template>
</v-snackbar>


{% endblock %}

{% block js %}
<script>
const { createApp } = Vue;
const { createVuetify } = Vuetify;
const vuetify = createVuetify(config.vuetifyConfig);

const app = createApp({
    data() {
        return {
            menu: null,
            drawer: true,
            workspaces: [],
            createDialog: false,
            newWorkspaceName: '',
            creating: false,
            snackBar: false,
            snackMessage: '',
            snackColor: 'success',

            rules: {
                required: value => !!value || 'Required'
            }
        };
    },
    delimiters: config.delimiters,
    
    mounted() {
        // Load workspace data from template (already includes user roles)
        this.workspaces = {{ workspaces | tojson | safe }};
    },
    
    methods: {
        showSnack(message, color = 'success') {
            this.snackMessage = message;
            this.snackColor = color;
            this.snackBar = true;
        },
        
        async createWorkspace() {
            if (!this.newWorkspaceName.trim()) {
                this.showSnack('Workspace name is required', 'error');
                return;
            }
            
            this.creating = true;
            
            try {
                const response = await axios.post('/api/workspaces', {
                    name: this.newWorkspaceName.trim()
                });
                
                this.showSnack('Workspace created successfully!');
                this.createDialog = false;
                this.newWorkspaceName = '';
                
                // Redirect to the new workspace
                window.location.href = `/workspace/${response.data.workspace.id}/switch/`;
                
            } catch (error) {
                this.showSnack(
                    error.response?.data?.error || 'Failed to create workspace', 
                    'error'
                );
            } finally {
                this.creating = false;
            }
        },

        formatDate(dateString) {
            if (!dateString) return 'Unknown';
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
    }
});

app.use(vuetify).mount('#app');
</script>
{% endblock %}
